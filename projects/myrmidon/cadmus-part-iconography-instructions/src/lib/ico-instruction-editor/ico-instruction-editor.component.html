<form [formGroup]="form" (submit)="save()">
  <mat-tab-group>
    <!-- GENERAL -->
    <mat-tab label="General">
      <!-- eid -->
      <div>
        <mat-form-field>
          <mat-label>EID</mat-label>
          <input matInput [formControl]="eid" />
          @if ($any(eid).errors?.maxLength && (eid.dirty || eid.touched)) {
          <mat-error>EID too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- types -->
      <div>
        <fieldset>
          <legend>types</legend>
          <!-- new type form -->
          <form [formGroup]="typeForm" (submit)="addType()">
            <fieldset>
              <div class="form-row">
                <!-- type (bound) -->
                @if (instrTypeEntries()?.length) {
                <mat-form-field>
                  <mat-label>type</mat-label>
                  <mat-select [formControl]="type">
                    @for (e of instrTypeEntries(); track e.id) {
                    <mat-option [value]="e.id">{{ e.value }}</mat-option>
                    }
                  </mat-select>
                  @if ($any(type).errors?.required && (type.dirty ||
                  type.touched)) {
                  <mat-error>type required</mat-error>
                  }
                </mat-form-field>
                } @else {
                <!-- type (free) -->
                <mat-form-field>
                  <mat-label>type</mat-label>
                  <input matInput [formControl]="type" />
                  @if ($any(type).errors?.required && (type.dirty ||
                  type.touched)) {
                  <mat-error>type required</mat-error>
                  } @if ($any(type).errors?.maxLength && (type.dirty ||
                  type.touched)) {
                  <mat-error>type too long</mat-error>
                  }
                </mat-form-field>
                }

                <!-- typeTag (bound) -->
                @if (instrTypeTagEntries()?.length) {
                <mat-form-field>
                  <mat-label>type tag</mat-label>
                  <mat-select [formControl]="typeTag">
                    @for (e of instrTypeTagEntries(); track e.id) {
                    <mat-option [value]="e.id">{{ e.value }}</mat-option>
                    }
                  </mat-select>
                  @if ($any(typeTag).errors?.required && (typeTag.dirty ||
                  typeTag.touched)) {
                  <mat-error>type tag required</mat-error>
                  }
                </mat-form-field>
                } @else {
                <!-- typeTag (free) -->
                <mat-form-field>
                  <mat-label>type tag</mat-label>
                  <input matInput [formControl]="typeTag" />
                  @if ($any(typeTag).errors?.required && (typeTag.dirty ||
                  typeTag.touched)) {
                  <mat-error>type tag required</mat-error>
                  } @if ($any(typeTag).errors?.maxLength && (typeTag.dirty ||
                  typeTag.touched)) {
                  <mat-error>type tag too long</mat-error>
                  }
                </mat-form-field>
                }

                <!-- add button -->
                <button
                  type="submit"
                  mat-icon-button
                  matTooltip="Add type"
                  [disabled]="typeForm.invalid"
                >
                  <mat-icon class="mat-primary">add_circle</mat-icon>
                </button>
              </div>
            </fieldset>
          </form>

          <!-- types list -->
          @if (types.value.length) {
          <table>
            <thead>
              <tr>
                <th></th>
                <th>type</th>
                <th>tag</th>
              </tr>
            </thead>
            <tbody>
              @for (entry of types.value; track entry; let i = $index; let first
              = $first; let last = $last) {
              <tr>
                <td class="fit-width">
                  <button
                    type="button"
                    mat-icon-button
                    matTooltip="Move this type up"
                    [disabled]="first"
                    (click)="moveTypeUp(i)"
                  >
                    <mat-icon>arrow_upward</mat-icon>
                  </button>
                  <button
                    type="button"
                    mat-icon-button
                    matTooltip="Move this type down"
                    [disabled]="last"
                    (click)="moveTypeDown(i)"
                  >
                    <mat-icon>arrow_downward</mat-icon>
                  </button>
                  <button
                    type="button"
                    mat-icon-button
                    color="warn"
                    matTooltip="Delete this type"
                    (click)="deleteType(i)"
                  >
                    <mat-icon class="mat-warn">remove_circle</mat-icon>
                  </button>
                </td>
                <td>
                  {{
                    entry.value
                      | flatLookup : instrTypeEntries() : "id" : "value"
                  }}
                </td>
                <td>
                  {{
                    entry.tag
                      | flatLookup : instrTypeTagEntries() : "id" : "value"
                  }}
                </td>
              </tr>
              }
            </tbody>
          </table>
          }
        </fieldset>
      </div>

      <!-- script -->
      <div class="form-row mt">
        <!-- script (bound) -->
        @if (instrScriptEntries()?.length) {
        <mat-form-field>
          <mat-label>script</mat-label>
          <mat-select [formControl]="script">
            @for (e of instrScriptEntries(); track e.id) {
            <mat-option [value]="e.id">{{ e.value }}</mat-option>
            }
          </mat-select>
          @if ($any(script).errors?.required && (script.dirty ||
          script.touched)) {
          <mat-error>script required</mat-error>
          }
        </mat-form-field>
        } @else {
        <!-- script (free) -->
        <mat-form-field>
          <mat-label>script</mat-label>
          <input matInput [formControl]="script" />
          @if ($any(script).errors?.required && (script.dirty ||
          script.touched)) {
          <mat-error>script required</mat-error>
          } @if ($any(script).errors?.maxLength && (script.dirty ||
          script.touched)) {
          <mat-error>script too long</mat-error>
          }
        </mat-form-field>
        }

        <!-- subject -->
        <mat-form-field>
          <mat-label>subject</mat-label>
          <input matInput [formControl]="subject" />
          @if ($any(subject).errors?.maxLength && (subject.dirty ||
          subject.touched)) {
          <mat-error>subject too long</mat-error>
          }
        </mat-form-field>

        <!-- repertoire -->
        <mat-form-field>
          <mat-label>repertoire</mat-label>
          <input matInput [formControl]="repertoire" />
          @if ($any(repertoire).errors?.maxLength && (repertoire.dirty ||
          repertoire.touched)) {
          <mat-error>repertoire too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- languages -->
      @if (languageFlags().length) {
      <div>
        <cadmus-ui-flag-set
          [flags]="languageFlags()"
          [checkedIds]="languages.value"
          (checkedIdsChange)="onLanguageCheckedIdsChange($event)"
        />
      </div>
      }

      <!-- text -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>text</mat-label>
          <textarea matInput [formControl]="text" rows="3"></textarea>
          @if ($any(text).errors?.maxLength && (text.dirty || text.touched)) {
          <mat-error>text too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- sequences (space-delimited) -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>sequences</mat-label>
          <textarea matInput [formControl]="sequences"></textarea>
          @if ($any(sequences).errors?.maxLength && (sequences.dirty ||
          sequences.touched)) {
          <mat-error>sequences too long</mat-error>
          }
          <mat-hint>space-delimited</mat-hint>
        </mat-form-field>
      </div>

      <!-- locations -->
      <div class="form-row mt">
        <!-- location -->
        <mat-form-field>
          <mat-label>location</mat-label>
          <input matInput [formControl]="location" />
          @if ($any(location).errors?.maxLength && (location.dirty ||
          location.touched)) {
          <mat-error>location too long</mat-error>
          }
        </mat-form-field>

        <!-- target location -->
        <mat-form-field>
          <mat-label>target location</mat-label>
          <input matInput [formControl]="targetLocation" />
          @if ($any(targetLocation).errors?.maxLength && (targetLocation.dirty
          || targetLocation.touched)) {
          <mat-error>target location too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- position -->
      <div>
        <fieldset>
          <legend>position</legend>
          <div class="form-row">
            <!-- position (bound) -->
            @if (instrPositionEntries()?.length) {
            <mat-form-field>
              <mat-label>position</mat-label>
              <mat-select [formControl]="position">
                @for (e of instrPositionEntries(); track e.id) {
                <mat-option [value]="e.id">{{ e.value }}</mat-option>
                }
              </mat-select>
              @if ($any(position).errors?.required && (position.dirty ||
              position.touched)) {
              <mat-error>position required</mat-error>
              }
            </mat-form-field>
            } @else {
            <!-- position (free) -->
            <mat-form-field>
              <mat-label>position</mat-label>
              <input matInput [formControl]="position" />
              @if ($any(position).errors?.required && (position.dirty ||
              position.touched)) {
              <mat-error>position required</mat-error>
              } @if ($any(position).errors?.maxLength && (position.dirty ||
              position.touched)) {
              <mat-error>position too long</mat-error>
              }
            </mat-form-field>
            }

            <!-- positionNote -->
            <mat-form-field class="long-text">
              <mat-label>position note</mat-label>
              <textarea matInput [formControl]="positionNote"></textarea>
              @if ($any(positionNote).errors?.maxLength && (positionNote.dirty
              || positionNote.touched)) {
              <mat-error>position note too long</mat-error>
              }
            </mat-form-field>
          </div>
        </fieldset>
      </div>

      <div>
        <fieldset>
          <legend>date</legend>
          <!-- date-->
          <mat-checkbox [formControl]="hasDate">date</mat-checkbox>
          @if (hasDate.value) {
          <cadmus-refs-historical-date
            [date]="date.value || undefined"
            (dateChange)="onDateChange($event!)"
          />
          }

          <!-- assertion -->
          <div>
            <fieldset>
              <legend>assertion</legend>
              <cadmus-refs-assertion
                [assTagEntries]="assTagEntries()"
                [refTagEntries]="docRefTagEntries()"
                [refTypeEntries]="docRefTypeEntries()"
                [assertion]="assertion.value || undefined"
                (assertionChange)="onAssertionChange($event!)"
              />
            </fieldset>
          </div>
        </fieldset>
      </div>

      <!-- note -->
      <div class="mt">
        <mat-form-field class="long-text">
          <mat-label>note</mat-label>
          <textarea matInput [formControl]="note" rows="3"></textarea>
          @if ($any(note).errors?.maxLength && (note.dirty || note.touched)) {
          <mat-error>note too long</mat-error>
          }
        </mat-form-field>
      </div>
    </mat-tab>

    <!-- IMPLEMENTATION -->
    <mat-tab label="Implementation">
      <!-- implementation -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>implementation</mat-label>
          <textarea matInput [formControl]="implementation" rows="3"></textarea>
          @if ($any(implementation).errors?.maxLength && (implementation.dirty
          || implementation.touched)) {
          <mat-error>implementation too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- diffs -->
      <div>
        <div>
          <button
            type="button"
            mat-flat-button
            color="primary"
            (click)="addDiff()"
          >
            <mat-icon>add_circle</mat-icon> diff
          </button>
        </div>
        @if (differences.value.length) {
        <table>
          <thead>
            <tr>
              <th></th>
              <th>type</th>
              <th>target</th>
            </tr>
          </thead>
          <tbody>
            @for (entry of differences.value; track entry; let i = $index; let
            first = $first; let last = $last) {
            <tr [class.selected]="i === editedDiffIndex()">
              <td class="fit-width">
                <button
                  type="button"
                  mat-icon-button
                  color="primary"
                  matTooltip="Edit this diff"
                  (click)="editDiff(entry, i)"
                >
                  <mat-icon class="mat-primary">edit</mat-icon>
                </button>
                <button
                  type="button"
                  mat-icon-button
                  matTooltip="Move this diff up"
                  [disabled]="first"
                  (click)="moveDiffUp(i)"
                >
                  <mat-icon>arrow_upward</mat-icon>
                </button>
                <button
                  type="button"
                  mat-icon-button
                  matTooltip="Move this diff down"
                  [disabled]="last"
                  (click)="moveDiffDown(i)"
                >
                  <mat-icon>arrow_downward</mat-icon>
                </button>
                <button
                  type="button"
                  mat-icon-button
                  color="warn"
                  matTooltip="Delete this diff"
                  (click)="deleteDiff(i)"
                >
                  <mat-icon class="mat-warn">remove_circle</mat-icon>
                </button>
              </td>
              <td>
                {{
                  entry.type
                    | flatLookup : instrDiffTypeEntries() : "id" : "value"
                }}
              </td>
              <td>{{ entry.target }}</td>
            </tr>
            }
          </tbody>
        </table>
        } @if (editedDiff()) {
        <fieldset>
          <mat-expansion-panel
            [expanded]="editedDiff()"
            [disabled]="!editedDiff()"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>Diff #</mat-panel-title>
            </mat-expansion-panel-header>
            <cadmus-ico-instruction-diff-editor
              [instrDiffTypeEntries]="instrDiffTypeEntries()"
              [diff]="editedDiff()"
              (diffChange)="saveDiff($event!)"
              (cancelEdit)="closeDiff()"
            />
          </mat-expansion-panel>
        </fieldset>
        }
      </div>
    </mat-tab>

    <!-- DESCRIPTION -->
    <mat-tab label="Description">
      <!-- description -->
      <div>
        <mat-form-field class="long-text">
          <mat-label>description</mat-label>
          <textarea matInput [formControl]="description" rows="3"></textarea>
          @if ($any(description).errors?.maxLength && (description.dirty ||
          description.touched)) {
          <mat-error>description too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- features -->
      @if (featureFlags().length) {
      <div class="mt">
        <fieldset>
          <legend>features</legend>
          <cadmus-ui-flag-set
            [flags]="featureFlags()"
            [checkedIds]="features.value"
            (checkedIdsChange)="onFeatureCheckedIdsChange($event)"
          />
        </fieldset>
      </div>
      }

      <!-- tools -->
      @if (toolFlags().length) {
      <div class="mt">
        <fieldset>
          <legend>tools</legend>
          <cadmus-ui-flag-set
            [flags]="toolFlags()"
            [checkedIds]="tools.value"
            (checkedIdsChange)="onToolCheckedIdsChange($event)"
          />
        </fieldset>
      </div>
      }

      <!-- colors -->
      @if (colorFlags().length) {
      <div class="mt">
        <fieldset>
          <legend>colors</legend>
          <cadmus-ui-flag-set
            [flags]="colorFlags()"
            [checkedIds]="colors.value"
            (checkedIdsChange)="onColorCheckedIdsChange($event)"
          />
        </fieldset>
      </div>
      }

      <!-- color reuses -->
      <div class="mt">
        <button
          type="button"
          mat-flat-button
          color="primary"
          (click)="addColorReuse()"
        >
          <mat-icon>add_circle</mat-icon> color reuse
        </button>
      </div>
      @if (colorReuses.value.length) {
      <table>
        <thead>
          <tr>
            <th></th>
            <th>color</th>
            <th>location</th>
          </tr>
        </thead>
        <tbody>
          @for (entry of colorReuses.value; track entry; let i = $index; let
          first = $first; let last = $last) {
          <tr [class.selected]="i === editedReuseIndex()">
            <td class="fit-width">
              <button
                type="button"
                mat-icon-button
                color="primary"
                matTooltip="Edit this color reuse"
                (click)="editColorReuse(entry, i)"
              >
                <mat-icon class="mat-primary">edit</mat-icon>
              </button>
              <button
                type="button"
                mat-icon-button
                matTooltip="Move this color reuse up"
                [disabled]="first"
                (click)="moveColorReuseUp(i)"
              >
                <mat-icon>arrow_upward</mat-icon>
              </button>
              <button
                type="button"
                mat-icon-button
                matTooltip="Move this color reuse down"
                [disabled]="last"
                (click)="moveColorReuseDown(i)"
              >
                <mat-icon>arrow_downward</mat-icon>
              </button>
              <button
                type="button"
                mat-icon-button
                color="warn"
                matTooltip="Delete this color reuse"
                (click)="deleteColorReuse(i)"
              >
                <mat-icon class="mat-warn">remove_circle</mat-icon>
              </button>
            </td>
            <td>
              {{
                entry.color | flatLookup : instrColorEntries() : "id" : "value"
              }}
            </td>
            <td>{{ entry.location }}</td>
          </tr>
          }
        </tbody>
      </table>
      } @if (editedReuse()) {
      <fieldset>
        <mat-expansion-panel
          [expanded]="editedReuse()"
          [disabled]="!editedReuse()"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>Color reuse #</mat-panel-title>
          </mat-expansion-panel-header>
          <cadmus-ico-color-reuse-editor
            [colorEntries]="instrColorEntries()"
            [reuse]="editedReuse()"
            (reuseChange)="saveColorReuse($event!)"
            (cancelEdit)="closeColorReuse()"
          />
        </mat-expansion-panel>
      </fieldset>
      }
    </mat-tab>

    <!-- LINKS -->
    <mat-tab label="Links">
      <cadmus-refs-asserted-composite-ids
        [idTagEntries]="assIdTagEntries()"
        [assTagEntries]="assTagEntries()"
        [refTagEntries]="docRefTagEntries()"
        [idScopeEntries]="assIdScopeEntries()"
        [refTypeEntries]="docRefTypeEntries()"
        [ids]="links.value"
        [canSwitchMode]="true"
        [canEditTarget]="true"
      />
    </mat-tab>
  </mat-tab-group>

  <!-- buttons -->
  <div>
    <button
      type="button"
      mat-icon-button
      matTooltip="Discard changes"
      (click)="cancel()"
    >
      <mat-icon class="mat-warn">clear</mat-icon>
    </button>
    <button
      type="submit"
      mat-icon-button
      matTooltip="Accept changes"
      [disabled]="form.invalid || form.pristine"
    >
      <mat-icon class="mat-primary">check_circle</mat-icon>
    </button>
  </div>
</form>
