<form [formGroup]="form" (submit)="save()">
  <mat-tab-group>
    <!-- GENERAL -->
    <mat-tab label="General">
      <!-- eid -->
      <div>
        <mat-form-field>
          <mat-label>EID</mat-label>
          <input matInput [formControl]="eid" />
          @if ($any(eid).errors?.maxLength && (eid.dirty || eid.touched)) {
          <mat-error>EID too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- types -->
      <div>
        <fieldset>
          <legend>types</legend>
          <!-- new type form -->
          <form [formGroup]="typeForm" (submit)="addType()">
            <fieldset>
              <div class="form-row">
                <!-- type (bound) -->
                @if (instrTypeEntries()?.length) {
                <mat-form-field>
                  <mat-label>type</mat-label>
                  <mat-select [formControl]="type">
                    @for (e of instrTypeEntries(); track e.id) {
                    <mat-option [value]="e.id">{{ e.value }}</mat-option>
                    }
                  </mat-select>
                  @if ($any(type).errors?.required && (type.dirty ||
                  type.touched)) {
                  <mat-error>type required</mat-error>
                  }
                </mat-form-field>
                } @else {
                <!-- type (free) -->
                <mat-form-field>
                  <mat-label>type</mat-label>
                  <input matInput [formControl]="type" />
                  @if ($any(type).errors?.required && (type.dirty ||
                  type.touched)) {
                  <mat-error>type required</mat-error>
                  } @if ($any(type).errors?.maxLength && (type.dirty ||
                  type.touched)) {
                  <mat-error>type too long</mat-error>
                  }
                </mat-form-field>
                }

                <!-- typeTag (bound) -->
                @if (instrTypeTagEntries()?.length) {
                <mat-form-field>
                  <mat-label>typeTag</mat-label>
                  <mat-select [formControl]="typeTag">
                    @for (e of instrTypeTagEntries(); track e.id) {
                    <mat-option [value]="e.id">{{ e.value }}</mat-option>
                    }
                  </mat-select>
                  @if ($any(typeTag).errors?.required && (typeTag.dirty ||
                  typeTag.touched)) {
                  <mat-error>typeTag required</mat-error>
                  }
                </mat-form-field>
                } @else {
                <!-- typeTag (free) -->
                <mat-form-field>
                  <mat-label>typeTag</mat-label>
                  <input matInput [formControl]="typeTag" />
                  @if ($any(typeTag).errors?.required && (typeTag.dirty ||
                  typeTag.touched)) {
                  <mat-error>typeTag required</mat-error>
                  } @if ($any(typeTag).errors?.maxLength && (typeTag.dirty ||
                  typeTag.touched)) {
                  <mat-error>typeTag too long</mat-error>
                  }
                </mat-form-field>
                }

                <!-- add button -->
                <button
                  type="submit"
                  mat-icon-button
                  matTooltip="Add type"
                  [disabled]="typeForm.invalid"
                >
                  <mat-icon class="mat-primary">add_circle</mat-icon>
                </button>
              </div>
            </fieldset>
          </form>

          <!-- types list -->
          @if (types.value.length) {
          <table>
            <thead>
              <tr>
                <th></th>
                <th>type</th>
                <th>tag</th>
              </tr>
            </thead>
            <tbody>
              @for (entry of types.value; track entry; let i = $index; let first
              = $first; let last = $last) {
              <tr>
                <td class="fit-width">
                  <button
                    type="button"
                    mat-icon-button
                    matTooltip="Move this type up"
                    [disabled]="first"
                    (click)="moveTypeUp(i)"
                  >
                    <mat-icon>arrow_upward</mat-icon>
                  </button>
                  <button
                    type="button"
                    mat-icon-button
                    matTooltip="Move this type down"
                    [disabled]="last"
                    (click)="moveTypeDown(i)"
                  >
                    <mat-icon>arrow_downward</mat-icon>
                  </button>
                  <button
                    type="button"
                    mat-icon-button
                    color="warn"
                    matTooltip="Delete this type"
                    (click)="deleteType(i)"
                  >
                    <mat-icon class="mat-warn">remove_circle</mat-icon>
                  </button>
                </td>
                <td>
                  {{
                    entry.value
                      | flatLookup : instrTypeEntries() : "id" : "value"
                  }}
                </td>
                <td>
                  {{
                    entry.tag
                      | flatLookup : instrTypeTagEntries() : "id" : "value"
                  }}
                </td>
              </tr>
              }
            </tbody>
          </table>

          }
        </fieldset>
      </div>

      <!-- script -->
      <div>
        <!-- script (bound) -->
        @if (instrScriptEntries()?.length) {
        <mat-form-field>
          <mat-label>script</mat-label>
          <mat-select [formControl]="script">
            @for (e of instrScriptEntries(); track e.id) {
            <mat-option [value]="e.id">{{ e.value }}</mat-option>
            }
          </mat-select>
          @if ($any(script).errors?.required && (script.dirty ||
          script.touched)) {
          <mat-error>script required</mat-error>
          }
        </mat-form-field>
        } @else {
        <!-- script (free) -->
        <mat-form-field>
          <mat-label>script</mat-label>
          <input matInput [formControl]="script" />
          @if ($any(script).errors?.required && (script.dirty ||
          script.touched)) {
          <mat-error>script required</mat-error>
          } @if ($any(script).errors?.maxLength && (script.dirty ||
          script.touched)) {
          <mat-error>script too long</mat-error>
          }
        </mat-form-field>
        }
      </div>

      <div class="form-row">
        <!-- subject -->
        <mat-form-field>
          <mat-label>subject</mat-label>
          <input matInput [formControl]="subject" />
          @if ($any(subject).errors?.maxLength && (subject.dirty ||
          subject.touched)) {
          <mat-error>subject too long</mat-error>
          }
        </mat-form-field>

        <!-- repertoire -->
        <mat-form-field>
          <mat-label>repertoire</mat-label>
          <input matInput [formControl]="repertoire" />
          @if ($any(repertoire).errors?.maxLength && (repertoire.dirty ||
          repertoire.touched)) {
          <mat-error>repertoire too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- languages -->
      @if (languageFlags().length) {
      <div>
        <cadmus-ui-flag-set
          [flags]="languageFlags()"
          [checkedIds]="languages.value"
          (checkedIdsChange)="onLanguageCheckedIdsChange($event)"
        />
      </div>
      }

      <!-- text -->
      <div>
        <mat-form-field>
          <mat-label>text</mat-label>
          <textarea matInput [formControl]="text" rows="3"></textarea>
          @if ($any(text).errors?.maxLength && (text.dirty || text.touched)) {
          <mat-error>text too long</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- sequences (space-delimited) -->
      <div>
        <mat-form-field>
          <mat-label>sequences</mat-label>
          <textarea matInput [formControl]="sequences" rows="3"></textarea>
          @if ($any(sequences).errors?.maxLength && (sequences.dirty ||
          sequences.touched)) {
          <mat-error>sequences too long</mat-error>
          }
          <mat-hint>space-delimited</mat-hint>
        </mat-form-field>
      </div>
    </mat-tab>

    <!-- IMPLEMENTATION -->
    <mat-tab label="Implementation"> </mat-tab>

    <!-- DESCRIPTION -->
    <mat-tab label="Description"> </mat-tab>
  </mat-tab-group>
  <!-- buttons -->
  <div>
    <button
      type="button"
      mat-icon-button
      matTooltip="Discard changes"
      (click)="cancel()"
    >
      <mat-icon class="mat-warn">clear</mat-icon>
    </button>
    <button
      type="submit"
      mat-icon-button
      matTooltip="Accept changes"
      [disabled]="form.invalid || form.pristine"
    >
      <mat-icon class="mat-primary">check_circle</mat-icon>
    </button>
  </div>
</form>
